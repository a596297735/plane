<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0"> -->
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>热狗大战</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        body,
        html {
            overflow: hidden;
            height: 100%;
            background-color: #000;
        }

        li {
            list-style: none;
        }

        #wrap {
            overflow: hidden;
            position: relative;
            left: 30%;
            width: 600px;
            height: 100%;
            background-image: url('./img/bg_1.jpg');
            background-repeat: no-repeat;
            background-size: 100% 100%;
        }

        /* 游戏难度选择 */
        #gameSelect {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 150px;
            color: red;
            text-align: center;
        }

        #gameSelect>ul {
            margin-top: 100px;
        }

        h1 {
            height: 50px;
            padding-bottom: 100px;
            line-height: 50px;
        }

        #gameSelect ul li {
            width: 150px;
            height: 50px;
            margin: 10px 0;
            line-height: 50px;
            font-size: 32px;
            cursor: pointer;
        }

        #gameSelect ul li:hover {
            color: #FFF;
        }

        #logo {
            width: 80px;
            height: 80px;
            margin: 0 auto;
            background-image: url('./img/regou.gif');
            background-size: 100% 100%;
        }

        /* 游戏结束 */
        #gameOver {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 300px;
            color: #FFF;
            font-size: 32px;
            line-height: 50px;
            padding-top: 100px;
            text-align: center;

        }

        #score {
            color: #f00;
        }

        /* 游戏开始 */
        #gameStart {
            display: none;
            width: 100%;
            height: 100%;
        }

        /* 我方王思聪 */
        #myplane {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 999;
        }

        .bullet {
            position: absolute;
            top: 0;
            left: 0;
        }

        /* 敌方飞机 */
        .enemy,
        .boom {
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>
</head>

<body>


    <div id="wrap">
        <!-- 选择难度 -->
        <div id="gameSelect">
            <h1>热狗大战</h1>
            <div id="logo"></div>
            <ul>
                <li>很少热狗</li>
                <li>正常热狗</li>
                <li>好多热狗</li>
                <li>超多热狗</li>
            </ul>
        </div>
        <!-- 开始游戏 -->
        <div id="gameStart">

        </div>
        <!-- 游戏结束 -->
        <div id="gameOver">
            <p>游戏结束！</p>
            您的积分是：<p id="score"></p>
        </div>
    </div>



</body>

<script>

    ; (function () {
        [...document.querySelectorAll("#gameSelect li")].forEach(function (item, index) {
            item.addEventListener('click', function (e) {
                // index 表示点击的是哪个难度  
                new Plane(e, index);

            }, false);
        });


        function Plane(e, index) {

            this.init(e, index);
        }

        Plane.prototype = {
            init(e, index) {
                this.wrap = document.getElementById("wrap"),
                this.gameStart = document.getElementById("gameStart"),
                this.gameSelect = document.getElementById("gameSelect"),
                this.gameOver = document.getElementById('gameOver');
                this.scoreBox = document.getElementById("score"),
                this.myplane = document.getElementById('myplane');
                this.enemyPlanes = document.getElementsByClassName("enemy")[0];
                this.bullet = document.getElementsByClassName("bullet");
                this.fireSpeed = [400, 300, 200, 100][index]; //开火速度
                this.time = [400, 300, 200, 100][index]; //敌机生成速度
                this.score = 0;
                this.showGameBox(); //隐藏选择难度的界面，显示游戏开始界面
                this.createMyPlane(e); // 创建我方王思聪
                this.myPlaneMove(); // 我方王思聪移动
                this.fire(this.fireSpeed); // 开火
                this.createEnemyPlane(this.time);  // 创建敌方飞机并下落
            },
            showGameBox() {
                this.gameSelect.style.display = 'none';
                this.gameStart.style.display = 'block';
            },
            showGameOver(){
                this.scoreBox.innerText = this.score;
                this.gameOver.style.display = 'block';
            },
            createMyPlane(e) {
                this.myplane = new Image();
                this.myplane.setAttribute('id', 'myplane');
                this.myplane.src = './img/myplane.png';
                this.myplane.width = 60;
                this.myplane.height = 60;
                this.myplane.style.left = e.x - (this.wrap.offsetLeft + this.myplane.width / 2) + 'px';
                this.myplane.style.top = e.y - (this.myplane.height / 2) + 'px';
                this.gameStart.appendChild(this.myplane);
            },
            myPlaneMove() {
                let that = this;
                window.onmousemove = function (e) {
                    that.nowLeft = e.x - (that.wrap.offsetLeft + that.myplane.width / 2);
                    that.nowTop = e.y - (that.myplane.height / 2);
                    that.maxLeft = that.wrap.offsetWidth - that.myplane.width;
                    that.minLeft = 0;
                    that.maxTop = that.wrap.offsetHeight - that.myplane.offsetHeight;
                    that.minTop = 0;

                    if (that.nowLeft < that.minLeft) {
                        that.nowLeft = that.minLeft
                    }
                    if (that.nowLeft > that.maxLeft) {
                        that.nowLeft = that.maxLeft;
                    }
                    if (that.nowTop < that.minTop) {
                        that.nowTop = that.minTop;
                    }
                    if (that.nowTop > that.maxTop) {
                        that.nowTop = that.maxTop;
                    }
                    that.myplane.style.left = that.nowLeft + 'px';
                    that.myplane.style.top = that.nowTop + 'px';
                }.bind(this)
            },
            fire(speed) {
               fireTimer =  setInterval(function () {
                    let bullet = new Image();
                    bullet.className = 'bullet';
                    bullet.src = './img/hotDog.png';
                    bullet.width = 60;
                    bullet.height = 80;
                    bullet.style.top = myplane.offsetTop - myplane.offsetHeight + "px";
                    bullet.style.left = myplane.offsetLeft + "px";
                    gameStart.appendChild(bullet);

                    function move() {
                        let nowTop = bullet.offsetTop;
                        nowTop -= 10;
                        bullet.style.top = nowTop + 'px';

                        // 碰撞检测
                        this.isCollision(document.getElementsByClassName('enemy'), bullet)


                        if (bullet.offsetTop <= -bullet.offsetHeight) { //子弹超过屏幕高度后移除
                            bullet.remove();
                        } else {
                            requestAnimationFrame(move.bind(this));
                        }

                    }
                    move.call(this);
                }.bind(this), this.fireSpeed)
            },
            createEnemyPlane(speed) {
                let num = 0;
                createEnemyTimer  = setInterval(function () {
                    let  smallOrBig = ++num % 5; 
                    this.enemy = new Image(); 
                    if(smallOrBig) this.enemy.classList.add("small");
                    else  this.enemy.classList.add("big");
                    this.enemy.classList.add('enemy');
                    this.enemy.src = smallOrBig ?'./img/enemy_small.png':'./img/enemy_big.png';
                    this.enemy.width = smallOrBig ? 60 : 200;
                    this.enemy.height = smallOrBig ? 60 : 160;
                    this.enemy.style.left = this.createRandom(-this.enemy.width / 2, this.wrap.offsetWidth - this.enemy.width / 2) + 'px';//敌机左右最大活动范围
                    this.enemy.style.top = - 100 + 'px';
                    this.gameStart.appendChild(this.enemy);
                    this.speed = this.createRandom(2, 5); // 敌机随机下落速度
                    this.enemyMove(this.enemy, this.speed);
                }.bind(this), this.time);

            },
            enemyMove(enemy, speed) {
                if(document.getElementById('myplane')){ //王思聪存在的话才调用检测碰撞
                    this.isCollision(enemy,myplane); 
                }
                let nowTop = enemy.offsetTop;
                nowTop += speed;
                enemy.style.top = nowTop + 'px';
                if (enemy.offsetTop > this.maxTop) {
                    enemy.remove()
                } else {
                    requestAnimationFrame(this.enemyMove.bind(this, enemy, speed));
                }
            },            
            createRandom(min, max) {
                return Math.floor(Math.random() * (max - min + 1) + min);
            },
            isCollision(enemys, ele) {
                if(enemys.length>0){
                    [...enemys].forEach(function (enemy) {
                    let L1 = enemy.offsetLeft,
                        U1 = enemy.offsetTop,
                        R1 = enemy.offsetLeft + enemy.offsetWidth,
                        B1 = enemy.offsetTop + enemy.offsetWidth,

                        L2 = ele.offsetLeft,
                        U2 = ele.offsetTop,
                        R2 = ele.offsetLeft + ele.offsetWidth,
                        B2 = ele.offsetTop + ele.offsetHeight;

                    if (R1 >= L2 && B1 >= U2 && L1 <= R2 && U1 <= B2) {
                        if(enemy.classList.contains("big")) this.score += 500
                        else this.score += 100 
                        enemy.remove(); //子弹碰撞敌机后移除敌机
                        this.boom(enemy); // 敌机爆炸后的图片
                    }

                }.bind(this))
                }else{
                    let L1 = enemys.offsetLeft,
                        U1 = enemys.offsetTop,
                        R1 = enemys.offsetLeft + enemys.offsetWidth,
                        B1 = enemys.offsetTop + enemys.offsetWidth,

                        L2 = ele.offsetLeft,
                        U2 = ele.offsetTop,
                        R2 = ele.offsetLeft + ele.offsetWidth,
                        B2 = ele.offsetTop + ele.offsetHeight;

                    if (R1 >= L2 && B1 >= U2 && L1 <= R2 && U1 <= B2) { 
                        clearInterval(createEnemyTimer)
                        clearInterval(fireTimer)
                        this.gameStart.remove();
                        this.showGameOver();
                    }
                }

            },
            boom(enemy) {
                let boom = new Image();
                boom.src = './img/boom_small.png';
                boom.className = 'boom';
                boom.width = 60;
                boom.height = 60;
                boom.style.left = parseInt(enemy.style.left) + 'px';
                boom.style.top = parseInt(enemy.style.top) + 'px';
                this.gameStart.appendChild(boom);
                setTimeout(function () {
                    boom.remove();
                }, 500)
            }
        }

    }())

</script>


</html>